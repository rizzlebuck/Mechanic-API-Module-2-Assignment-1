swagger: '2.0'
info:
  title: "Mechanic Shop Advanced API"
  description: "Advanced mechanic shop API with auth, rate limits, inventory, and tickets."
  version: "1.0.0"

host: "mechanic-api-module-2-assignment-1.onrender.com" 
schemes:
  - "https"

consumes:
  - "application/json"
produces:
  - "application/json"

securityDefinitions:
  bearerAuth:
    type: apiKey
    name: Authorization
    in: header

paths:
  /customers:
    post:
      tags:
        - Customers
      summary: "Create a new customer"
      description: "Registers a new customer with name, email, and password."
      parameters:
        - in: "body"
          name: "body"
          description: "Customer registration data"
          required: true
          schema:
            $ref: "#/definitions/CustomerCreatePayload"
      responses:
        201:
          description: "Customer created successfully"
          schema:
            $ref: "#/definitions/CustomerResponse"
          examples:
            application/json:
              id: 1
              name: "John Doe"
              email: "john@example.com"
        400:
          description: "Invalid payload or email already used"
    get:
      tags:
        - Customers
      summary: "Get customers (paginated)"
      description: "Returns a paginated list of customers."
      parameters:
        - in: "query"
          name: "page"
          type: "integer"
          required: false
          description: "Page number (default: 1)"
        - in: "query"
          name: "per_page"
          type: "integer"
          required: false
          description: "Items per page (default: 5)"
      responses:
        200:
          description: "Retrieved customers"
          schema:
            $ref: "#/definitions/CustomerListResponse"

  /customers/login:
    post:
      tags:
        - Customers
      summary: "Login (rate limited)"
      description: "Validates customer credentials and returns a JWT token. This route is rate limited."
      parameters:
        - in: "body"
          name: "body"
          description: "Login credentials"
          required: true
          schema:
            $ref: "#/definitions/LoginCredentials"
      responses:
        200:
          description: "Login successful"
          schema:
            $ref: "#/definitions/LoginResponse"
          examples:
            application/json:
              token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        400:
          description: "Validation error"
        401:
          description: "Invalid credentials"

  /customers/my-tickets:
    get:
      tags:
        - Customers
      summary: "Get tickets for the logged-in customer"
      description: "Returns all service tickets that belong to the authenticated customer."
      security:
        - bearerAuth: []
      responses:
        200:
          description: "Retrieved customer's tickets successfully"
          schema:
            type: "array"
            items:
              $ref: "#/definitions/ServiceTicketResponse"
        401:
          description: "Missing or invalid token"

  /mechanics:
    post:
      tags:
        - Mechanics
      summary: "Create mechanic"
      description: "Creates a new mechanic record."
      parameters:
        - in: "body"
          name: "body"
          description: "Mechanic data"
          required: true
          schema:
            $ref: "#/definitions/MechanicPayload"
      responses:
        201:
          description: "Mechanic created"
          schema:
            $ref: "#/definitions/MechanicResponse"
          examples:
            application/json:
              id: 1
              name: "Alex Wrench"
              specialization: "Engine Repair"
              is_active: true
    get:
      tags:
        - Mechanics
      summary: "Get all mechanics (cached)"
      description: "Returns all mechanics. This route is cached for performance."
      responses:
        200:
          description: "List of mechanics"
          schema:
            type: "array"
            items:
              $ref: "#/definitions/MechanicResponse"

  /mechanics/{id}:
    put:
      tags:
        - Mechanics
      summary: "Update mechanic"
      description: "Updates an existing mechanic."
      parameters:
        - in: "path"
          name: "id"
          type: "integer"
          required: true
          description: "Mechanic ID"
        - in: "body"
          name: "body"
          description: "Mechanic fields to update"
          required: true
          schema:
            $ref: "#/definitions/MechanicPayload"
      responses:
        200:
          description: "Updated mechanic"
          schema:
            $ref: "#/definitions/MechanicResponse"
        404:
          description: "Mechanic not found"
    delete:
      tags:
        - Mechanics
      summary: "Delete mechanic"
      description: "Deletes a mechanic by ID."
      parameters:
        - in: "path"
          name: "id"
          type: "integer"
          required: true
          description: "Mechanic ID"
      responses:
        200:
          description: "Mechanic deleted"
          schema:
            $ref: "#/definitions/BasicMessageResponse"
          examples:
            application/json:
              message: "Mechanic 1 deleted"
        404:
          description: "Mechanic not found"

  /mechanics/by-ticket-count:
    get:
      tags:
        - Mechanics
      summary: "Mechanics ordered by number of tickets"
      description: "Returns mechanics sorted by how many tickets they have worked on."
      responses:
        200:
          description: "Mechanics with ticket counts"
          schema:
            type: "array"
            items:
              $ref: "#/definitions/MechanicWithTicketCount"

  /service-tickets:
    post:
      tags:
        - Service Tickets
      summary: "Create service ticket"
      description: "Creates a new service ticket for the authenticated customer."
      security:
        - bearerAuth: []
      parameters:
        - in: "body"
          name: "body"
          description: "Ticket data"
          required: true
          schema:
            $ref: "#/definitions/ServiceTicketCreatePayload"
      responses:
        201:
          description: "Ticket created"
          schema:
            $ref: "#/definitions/ServiceTicketResponse"
          examples:
            application/json:
              id: 1
              description: "Brake pads worn out"
              vehicle: "Honda Civic"
              status: "open"
        401:
          description: "Unauthorized"
    get:
      tags:
        - Service Tickets
      summary: "Get all service tickets"
      description: "Returns all service tickets."
      responses:
        200:
          description: "List of tickets"
          schema:
            type: "array"
            items:
              $ref: "#/definitions/ServiceTicketResponse"

  /service-tickets/{ticket_id}/edit:
    put:
      tags:
        - Service Tickets
      summary: "Edit mechanics assigned to a ticket"
      description: "Adds or removes mechanics from a service ticket. Requires that the authenticated customer owns the ticket."
      security:
        - bearerAuth: []
      parameters:
        - in: "path"
          name: "ticket_id"
          type: "integer"
          required: true
          description: "Ticket ID"
        - in: "body"
          name: "body"
          description: "Mechanic IDs to add or remove"
          required: true
          schema:
            $ref: "#/definitions/EditTicketMechanicsPayload"
      responses:
        200:
          description: "Updated ticket with new mechanics"
          schema:
            $ref: "#/definitions/ServiceTicketResponse"
        403:
          description: "Not authorized to modify this ticket"
        404:
          description: "Ticket not found"

  /service-tickets/{ticket_id}/add-part/{inventory_id}:
    put:
      tags:
        - Service Tickets
      summary: "Add a part to a ticket"
      description: "Adds a single inventory part to the given service ticket. Requires that the authenticated customer owns the ticket."
      security:
        - bearerAuth: []
      parameters:
        - in: "path"
          name: "ticket_id"
          type: "integer"
          required: true
          description: "Ticket ID"
        - in: "path"
          name: "inventory_id"
          type: "integer"
          required: true
          description: "Inventory item ID"
      responses:
        200:
          description: "Ticket updated with part"
          schema:
            $ref: "#/definitions/ServiceTicketResponse"
        403:
          description: "Not authorized to modify this ticket"
        404:
          description: "Ticket or part not found"

  /inventory:
    post:
      tags:
        - Inventory
      summary: "Create inventory item"
      description: "Creates a new inventory part. Requires authentication."
      security:
        - bearerAuth: []
      parameters:
        - in: "body"
          name: "body"
          description: "Inventory item data"
          required: true
          schema:
            $ref: "#/definitions/InventoryPayload"
      responses:
        201:
          description: "Inventory item created"
          schema:
            $ref: "#/definitions/InventoryResponse"
          examples:
            application/json:
              id: 1
              name: "Brake Pad Set"
              price: 89.99
        401:
          description: "Unauthorized"
    get:
      tags:
        - Inventory
      summary: "Get all inventory items"
      description: "Returns all inventory parts."
      responses:
        200:
          description: "List of inventory items"
          schema:
            type: "array"
            items:
              $ref: "#/definitions/InventoryResponse"

  /inventory/{item_id}:
    get:
      tags:
        - Inventory
      summary: "Get a single inventory item"
      description: "Returns a single inventory part by ID."
      parameters:
        - in: "path"
          name: "item_id"
          type: "integer"
          required: true
          description: "Inventory item ID"
      responses:
        200:
          description: "Found inventory item"
          schema:
            $ref: "#/definitions/InventoryResponse"
        404:
          description: "Item not found"
    put:
      tags:
        - Inventory
      summary: "Update an inventory item"
      description: "Updates an existing inventory part. Requires authentication."
      security:
        - bearerAuth: []
      parameters:
        - in: "path"
          name: "item_id"
          type: "integer"
          required: true
          description: "Inventory item ID"
        - in: "body"
          name: "body"
          description: "Fields to update"
          required: true
          schema:
            $ref: "#/definitions/InventoryPayload"
      responses:
        200:
          description: "Updated inventory item"
          schema:
            $ref: "#/definitions/InventoryResponse"
        404:
          description: "Item not found"
    delete:
      tags:
        - Inventory
      summary: "Delete inventory item"
      description: "Deletes an inventory part by ID. Requires authentication."
      security:
        - bearerAuth: []
      parameters:
        - in: "path"
          name: "item_id"
          type: "integer"
          required: true
          description: "Inventory item ID"
      responses:
        200:
          description: "Deleted inventory item"
          schema:
            $ref: "#/definitions/BasicMessageResponse"
          examples:
            application/json:
              message: "Inventory item 1 deleted"
        404:
          description: "Item not found"

definitions:
  BasicMessageResponse:
    type: "object"
    properties:
      message:
        type: "string"

  # Customers
  CustomerCreatePayload:
    type: "object"
    properties:
      name:
        type: "string"
      email:
        type: "string"
      password:
        type: "string"
    required:
      - name
      - email
      - password

  CustomerResponse:
    type: "object"
    properties:
      id:
        type: "integer"
      name:
        type: "string"
      email:
        type: "string"

  CustomerListResponse:
    type: "object"
    properties:
      items:
        type: "array"
        items:
          $ref: "#/definitions/CustomerResponse"
      total:
        type: "integer"
      page:
        type: "integer"
      per_page:
        type: "integer"
      pages:
        type: "integer"

  LoginCredentials:
    type: "object"
    properties:
      email:
        type: "string"
      password:
        type: "string"
    required:
      - email
      - password

  LoginResponse:
    type: "object"
    properties:
      token:
        type: "string"

  # Mechanics
  MechanicPayload:
    type: "object"
    properties:
      name:
        type: "string"
      specialization:
        type: "string"
      is_active:
        type: "boolean"

  MechanicResponse:
    type: "object"
    properties:
      id:
        type: "integer"
      name:
        type: "string"
      specialization:
        type: "string"
      is_active:
        type: "boolean"

  MechanicWithTicketCount:
    type: "object"
    properties:
      id:
        type: "integer"
      name:
        type: "string"
      specialization:
        type: "string"
      ticket_count:
        type: "integer"

  # Service Tickets
  ServiceTicketCreatePayload:
    type: "object"
    properties:
      description:
        type: "string"
      vehicle:
        type: "string"
      status:
        type: "string"
    required:
      - description

  EditTicketMechanicsPayload:
    type: "object"
    properties:
      add_ids:
        type: "array"
        items:
          type: "integer"
      remove_ids:
        type: "array"
        items:
          type: "integer"

  ServiceTicketResponse:
    type: "object"
    properties:
      id:
        type: "integer"
      description:
        type: "string"
      vehicle:
        type: "string"
      status:
        type: "string"
      customer_id:
        type: "integer"
      mechanics:
        type: "array"
        items:
          $ref: "#/definitions/MechanicResponse"
      parts:
        type: "array"
        items:
          $ref: "#/definitions/InventoryResponse"

  # Inventory
  InventoryPayload:
    type: "object"
    properties:
      name:
        type: "string"
      price:
        type: "number"
        format: "float"
    required:
      - name
      - price

  InventoryResponse:
    type: "object"
    properties:
      id:
        type: "integer"
      name:
        type: "string"
      price:
        type: "number"
        format: "float"
